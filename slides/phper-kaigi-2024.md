---
title: 雰囲気実装を少し抜け出そう！RFCからPHPの実装までを考えるタイムゾーンとサマータイム！！！
description:
class: invert
_class:
  - invert
  - lead
footer: 2024-03-07 | 雰囲気実装を少し抜け出そう！RFCからPHPの実装までを考えるタイムゾーンとサマータイム！！！
_footer: ""
paginate: false
_paginate: false
marp: true
---

<!-- https://qiita.com/takeshisakuma/items/5a61e6eac123d28602fb -->
# 雰囲気実装を少し抜け出そう！RFCからPHPの実装までを考えるタイムゾーンとサマータイム！！！

---

<!-- _class: lead -->
<!-- _footer: "" -->
<!-- _paginate: "" -->

# 自己紹介

---

![bg left:30% 80%](images/profile_up_minify.png)

### 所属

株式会社TechBowl

### 住んでるところ

東京

### 何やってる？

「TechTrain」というサービスで反復横跳びし続けている何でも屋さん(Laravel, Next.js, AWS, etc...)

### 趣味
 - お酒(よく溺れる)
 - サウナ
 - 読書

---

## TechTrain

![bg fit left:30% 80%](images/techtrain-logo.jpg)
エンジニア教育+Directスカウトのサービス。
Coding Stoicをテーマに「うるせえコードかけ！」と言いがちなメンターが多めのエンジニアを育てるためのサービスです。

---

# 筋がいい人ならちょっと教えてやってもいいぜ！という方がいたら
# ぜひTechTrainをメンターとして助けてもらえると嬉しいです！

---

# なぜ発表しようと思ったのか？

---

# PHPの言語やWeb標準にディープダイブしていきたい

## 巨人の肩に乗るためには標準を知った方が良い
## 歴史を遡っていけば、いいんじゃないか
## 言語の経緯を知った方がより良いコードが書けるのではないか

---

# さて！

---

# 雰囲気実装を少し抜け出そう！RFCからPHPの実装までを考えるタイムゾーンとサマータイム！！！

---

# 発表の想定フロー

1. 雰囲気実装を抜け出すために実際のサマータイムの定義と性質について説明する
2. 雰囲気実装だとやりがちな実装のサンプルを示し、1に違反しているところや問題点を指摘する
3. 逆に良い方法を示し、それに従った実装のサンプルを示す
4. 2->3とするための実装のリファクタリング方法を示す

どこかでアイスブレイクの場所を入れた方が発表に緩急がつくので、聞いてる人が楽しいかもしれない。

---

# 実装サンプルとしてありがちなやつの想定

1. サマータイムがない国の実装
2. サマータイムが進んで戻る際の実装の考慮がない実装(2回同じ日時が繰り返されるやつ)
3. タイムゾーン定義自体が永続的に変更される際の実装の考慮がない実装

---

# TODO

## RFCにおけるサマータイムについて調べる
## RFCにおけるサマータイムを考えずにやりがちな実装パターンを考える
## RFCにおけるサマータイムから逆算した最適な実装パターンを考える
## 実装パターンにおけるアンチパターンから最適なパターンに切り替えていく方法を考える

---

# TODO
wall-clock time とetを区別できていない実装のサンプルを出す

---

## RFCにおけるサマータイムについて調べる

1. wall-clock time（ローカル時間 や clock time とも呼ばれる、タイムゾーンに依存した時刻）
2. exact time（UTC 時間 とも呼ばれる、地球上のどこでも同じ時刻）を区別すること

---

Coordinated Universal Time （UTC）は、世界が時計と時刻を調整、規制するための時間の基準です。これは、経度 0 度における平均太陽時から 1 秒以内のものであり、サマータイムによる調整は行われていません。これは実質的にグリニッジ標準時（GMT）の後継です。
サマータイムの調整が行われているのは、wall-clock timeのみ。

---

ISO 8601とRFC 3339は特定の時刻と時間を表現するための標準規格です。例：2020-09-06T17:35:24.485Z。ここで Z は UTC を表す接尾辞です。

https://ja.wikipedia.org/wiki/ISO_8601
https://datatracker.ietf.org/doc/html/rfc3339

---

# タイムゾーンオフセットの変更とサマータイムを理解する
タイムゾーン は UTC と wall-clock がどのように関連しているかを定義します。
タイムゾーンは、exact time を受け取って UTC オフセットを返す関数、および反対方向への変換に対応する関数と考えられます。
（なぜ exact -> local の変換は 1 対 1 なのに、local -> exact への変換は曖昧なのかの理由は後述します）。

Temporal は IANA Time Zone Database（TZ database とも呼ばれる）を使用します。
これは、タイムゾーン関数の世界的なリポジトリであると考えられます。各 IANA タイムゾーンは以下のものを持ちます：

time zone ID は、地理的な範囲を市などで表したものです（例）。例えば Europe/Paris、Africa/Kampala などです。また、1 つのタイムゾーンオフセットも表すこともできます。例えば UTC（+00:00 オフセットの定数）や Etc/GMT+5（歴史的な経緯でこれは-05:00の意味）
タイムゾーンオフセット定義 は、すべての UTC のオフセットのデータベースで、1970 年 1 月 1 日からのすべての情報が記載されています（例）。これは、ある UTC の範囲（未来の範囲も含まれる）を特定のオフセットに写像するテーブルであると考えられます。いくつかのタイムゾーンは、オフセットが一時的に変わったりすることがあります。例えば サマータイム が導入されていると、春の初めと秋の終わりでオフセットが年に 2 回も変更されます。オフセットは、国がタイムゾーンを変更するように決定するなどの、政治的な理由で恒久的に変更される場合もまたあります。
TZ データベースは世界の政治的な変化によって年に数回アップデートされます。各アップデートにはタイムゾーン定義の変更が含まれます。これらの変更は通常は未来の date/time 値にのみ影響するものです。しかし、ごくまれに過去の範囲が修正されることもあります。例えば、20 世紀初頭の計時に関する新たな歴史的資料が発見された場合などです。

---

# Time Zone Databaseにより定義された各タイムゾーン

場合によってはUTCからの時間の差分（協定世界時との差）を複数持つ
典型的には、標準時と夏時間双方が同一のタイムゾーンに含まれる。

---

# サマータイムに入ると、実際には何が起こっているのか。

見た目: 時計が 1 時間進みます
実際: 時刻ではなくオフセットが動いている

オフセットが+1されて、サマータイムが終わる時には、オフセットが-1される。

---

### 参考リンク

https://tc39.es/proposal-temporal/docs/ja/ambiguity.html
https://ja.wikipedia.org/wiki/Tz_database
https://tex2e.github.io/rfc-translater/html/rfc5545.html

---

# ライブラリ候補

https://github.com/brick/date-time
https://github.com/briannesbitt/Carbon
https://github.com/fre5h/datetime-php
https://github.com/aeon-php/calendar

---

# まとめ

|種類|内容|
|:--|---|
|||
|||

---

# ご静聴ありがとうございました！

## 話しかけるの苦手なので、話しかけてもらえるととても嬉しいです！

---

# おまけ

---


---


---
